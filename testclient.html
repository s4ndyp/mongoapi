<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic API Test - Uitgebreid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-viewer {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .highlight-post {
            color: #4ade80; /* Groen */
        }
        .highlight-get {
            color: #6366f1; /* Indigo */
        }
        /* Zorgt ervoor dat de input velden voor de JWT de inhoud niet afkappen bij weergave */
        #apiKey {
            white-space: pre;
            overflow-x: auto;
        }
        .dimmed {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 p-8 font-sans">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-blue-400">Dynamic API Tester (v2)</h1>
        
        <p class="text-slate-400 mb-6 border-b border-slate-700 pb-3">
            Test de verbinding met de Taskey MongoAPI Gateway. Gebruik de login om de **HttpOnly cookie** te zetten (voor Cookie Mode) of haal het token op voor de **Header Mode**.
        </p>
        
        <div class="bg-slate-800 p-6 rounded-xl mb-6 border border-slate-700 shadow-xl">
            <h2 class="text-xl font-semibold mb-4 text-white">1. Login & Token Ophalen/Zetten</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-1">
                    <label class="block text-sm text-slate-400 mb-1">Gebruikersnaam</label>
                    <input type="text" id="loginUsername" placeholder="user" 
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm text-slate-400 mb-1">Wachtwoord</label>
                    <input type="password" id="loginPassword" placeholder="pass" 
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="md:col-span-2">
                    <button onclick="fetchToken()" class="w-full bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-lg font-medium shadow-md">
                        Login (Zet Cookie & Vul Token Veld)
                    </button>
                </div>
            </div>
            <p id="loginStatus" class="mt-3 text-sm text-yellow-400"></p>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl mb-6 border border-slate-700 shadow-xl">
            <h2 class="text-xl font-semibold mb-4 text-white">2. API Configuratie & Authenticatie Modus</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Authenticatie Modus</label>
                    <select id="authMode" onchange="toggleApiKeyField()" class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-white font-bold w-full">
                        <option value="header">Bearer Token (Header)</option>
                        <option value="cookie">HttpOnly Cookie</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm text-slate-400 mb-1">Bearer Token (JWT / API Key)</label>
                    <input type="text" id="apiKey" placeholder="Plak of vul het token in..." 
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Base URL (zonder /api)</label>
                    <input type="text" id="baseUrl" value="http://mongoapi:8080" 
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <p class="text-sm text-slate-400 mt-3">
                <span id="authModeHint">**Header Mode:** Vereist een token in het veld en stuurt dit via de 'Authorization' header.</span>
            </p>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl mb-6 border border-slate-700 shadow-xl">
            <h2 class="text-xl font-semibold mb-4 text-white">3. Request Maken</h2>
            
            <div class="flex flex-wrap gap-4 mb-4 items-end">
                <select id="method" class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-white font-bold w-24 flex-shrink-0">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm text-slate-400 mb-1">Endpoint / ID</label>
                    <div class="flex items-center bg-slate-900 border border-slate-600 rounded-lg px-3">
                        <span class="text-slate-400">/api/</span>
                        <input type="text" id="endpoint" placeholder="items/ID of projects?projectId=..." 
                            class="bg-transparent w-full p-2 text-white focus:outline-none">
                    </div>
                </div>
            </div>

            <div id="payloadContainer" class="hidden mb-4">
                <label class="block text-sm text-slate-400 mb-2">JSON Payload (Root Document)</label>
                <textarea id="payload" rows="8" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 font-mono text-sm">
{
  "content": "Testtaak vanuit de testclient",
  "type": "task",
  "projectId": "vervang_door_echte_id",
  "list": "inbox",
  "isComplete": false,
  "priority": "medium",
  "labels": ["test", "api"]
}</textarea>
            </div>

            <button onclick="sendRequest()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-medium shadow-md">Verstuur Request</button>
        </div>

        <div class="bg-slate-950 p-6 rounded-xl border border-slate-800 font-mono text-sm overflow-x-auto shadow-2xl">
            <div id="status" class="mb-3 font-bold text-slate-500">Klaar voor request...</div>
            <pre id="response" class="json-viewer text-slate-300"></pre>
        </div>
    </div>

    <script>
        document.getElementById('method').addEventListener('change', (e) => {
            const payload = document.getElementById('payloadContainer');
            const method = e.target.value;
            
            if (method === 'POST' || method === 'PUT') {
                payload.classList.remove('hidden');
            } else {
                payload.classList.add('hidden');
            }
        });

        // Roep deze aan bij het laden om de initiÃ«le staat goed te zetten
        document.addEventListener('DOMContentLoaded', toggleApiKeyField);

        function toggleApiKeyField() {
            const authMode = document.getElementById('authMode').value;
            const apiKeyEl = document.getElementById('apiKey');
            const hintEl = document.getElementById('authModeHint');

            if (authMode === 'cookie') {
                apiKeyEl.value = 'Token is opgeslagen als HttpOnly cookie door de browser.';
                apiKeyEl.classList.add('dimmed');
                apiKeyEl.setAttribute('disabled', 'true');
                hintEl.innerHTML = '**Cookie Mode:** De browser stuurt de cookie automatisch mee. Zorg dat je succesvol bent ingelogd bij stap 1.';
            } else {
                apiKeyEl.value = '';
                apiKeyEl.classList.remove('dimmed');
                apiKeyEl.removeAttribute('disabled');
                hintEl.innerHTML = '**Header Mode:** Vereist een token (JWT of API Key) in het veld en stuurt dit via de "Authorization" header.';
            }
        }


        function formatJson(data) {
            try {
                return JSON.stringify(data, null, 2);
            } catch (e) {
                return String(data);
            }
        }
        
        async function fetchToken() {
            const baseUrl = document.getElementById('baseUrl').value.trim().replace(/\/$/, '');
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const loginStatusEl = document.getElementById('loginStatus');
            const apiKeyEl = document.getElementById('apiKey');

            if (!username || !password) {
                loginStatusEl.textContent = 'Vul zowel gebruikersnaam als wachtwoord in.';
                loginStatusEl.className = 'mt-3 text-sm text-red-500';
                return;
            }

            loginStatusEl.textContent = 'Bezig met inloggen...';
            loginStatusEl.className = 'mt-3 text-sm text-yellow-400';

            const loginUrl = `${baseUrl}/api/auth/login`;

            try {
                const res = await fetch(loginUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (res.ok && data.token) {
                    // Zet het token in het veld voor Header Mode
                    if (document.getElementById('authMode').value === 'header') {
                         apiKeyEl.value = data.token;
                    }
                    loginStatusEl.textContent = 'Succes! JWT Token is gezet als HttpOnly cookie en het veld is gevuld (indien Header Mode).';
                    loginStatusEl.className = 'mt-3 text-sm text-green-500';
                } else {
                    const errorMsg = data.error || 'Onbekende fout bij authenticatie.';
                    loginStatusEl.textContent = `Fout bij login: ${errorMsg}`;
                    loginStatusEl.className = 'mt-3 text-sm text-red-500';
                }
            } catch (err) {
                loginStatusEl.textContent = `Netwerkfout: Kan geen verbinding maken met ${loginUrl}.`;
                loginStatusEl.className = 'mt-3 text-sm text-red-500';
            }
        }


        async function sendRequest() {
            const baseUrl = document.getElementById('baseUrl').value.trim().replace(/\/$/, '');
            const endpoint = document.getElementById('endpoint').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const method = document.getElementById('method').value;
            const authMode = document.getElementById('authMode').value; // Nieuwe variabele
            const responseEl = document.getElementById('response');
            const statusEl = document.getElementById('status');

            if (!endpoint) { 
                statusEl.className = "mb-3 font-bold text-red-500";
                statusEl.textContent = "Fout: Vul een endpoint naam in (bijv. items of items/ID)!"; 
                return; 
            }
            if (authMode === 'header' && !apiKey) {
                statusEl.className = "mb-3 font-bold text-red-500";
                statusEl.textContent = "Fout: Authenticatie Token (JWT/Key) is vereist in Header Mode!"; 
                return;
            }


            statusEl.className = "mb-3 font-bold text-yellow-500";
            statusEl.textContent = "Laden...";
            responseEl.textContent = "";
            
            const fullUrl = endpoint.startsWith('/api/') ? `${baseUrl}${endpoint}` : `${baseUrl}/api/${endpoint}`;

            const headers = {
                'Content-Type': 'application/json'
            };
            const options = { method, headers };

            // ðŸ”‘ LOGICA VOOR AUTHENTICATIE MODUS ðŸ”‘
            if (authMode === 'header') {
                // Stuur token mee via de Authorization header
                options.headers['Authorization'] = `Bearer ${apiKey}`;
                // Geen credentials nodig
                options.credentials = 'omit'; 
            } else if (authMode === 'cookie') {
                // Laat de browser de cookie meesturen
                options.credentials = 'include';
                // Verwijder de Authorization header, want we gebruiken de cookie
                delete options.headers['Authorization'];
            }
            // ------------------------------------

            if (method === 'POST' || method === 'PUT') {
                try {
                    options.body = document.getElementById('payload').value;
                    JSON.parse(options.body); // Valideer JSON
                } catch(e) {
                    statusEl.className = "mb-3 font-bold text-red-500";
                    statusEl.textContent = "Fout: Ongeldige JSON in payload."; 
                    responseEl.textContent = e.toString();
                    return;
                }
            }

            try {
                const res = await fetch(fullUrl, options);
                let data = null;
                
                if (res.status !== 204) {
                    try {
                        data = await res.json();
                    } catch (e) {
                        data = await res.text();
                        responseEl.textContent = data;
                        statusEl.className = res.ok ? "mb-3 font-bold text-yellow-500" : "mb-3 font-bold text-red-500";
                        statusEl.textContent = `Waarschuwing: Geen JSON respons! Status: ${res.status} ${res.statusText}`;
                        return;
                    }
                }

                if (res.ok) {
                    statusEl.className = method === 'POST' ? "mb-3 font-bold highlight-post" : "mb-3 font-bold highlight-get";
                    statusEl.textContent = `Succes: ${res.status} ${res.statusText}`;

                    if (data) {
                        responseEl.textContent = formatJson(data);
                    } else if (res.status === 204) {
                         responseEl.textContent = "204 No Content (DELETE succesvol)";
                    } else {
                         responseEl.textContent = "Geen data ontvangen.";
                    }
                } else {
                    statusEl.className = "mb-3 font-bold text-red-500";
                    
                    let errorMsg = `Fout: ${res.status} ${res.statusText}`;
                    if (data && data.error) {
                        errorMsg += ` - ${data.error}`;
                        responseEl.textContent = formatJson(data);
                    } else if (typeof data === 'string') {
                        responseEl.textContent = data;
                    }
                    statusEl.textContent = errorMsg;
                }

            } catch (err) {
                statusEl.className = "mb-3 font-bold text-red-500";
                statusEl.textContent = "Netwerk Fout: Kan geen verbinding maken of verzoek is mislukt.";
                responseEl.textContent = err.toString();
            }
        }
    </script>
</body>
</html>
