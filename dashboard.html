<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G2 API Dashboard</title>
    <!-- Laad Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconen: Lucide Icons -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark Background */
            color: #c9d1d9; /* Light Text */
            min-height: 100vh;
        }
        .card {
            background-color: #161b22; /* Darker Card */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: 1px solid #30363d;
        }
        .btn-primary {
            background-color: #238636; /* GitHub Green */
            color: white;
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #2ea043; 
        }
        .btn-danger {
            background-color: #da3633; /* GitHub Red */
            color: white;
            transition: background-color 0.15s;
        }
        .btn-danger:hover {
            background-color: #f85149; 
        }
        input, textarea, select {
            background-color: #0d1117 !important;
            border-color: #30363d !important;
            color: #c9d1d9 !important;
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        .tab-btn.active {
            border-bottom-color: #238636;
            color: #58a6ff; /* GitHub Blue */
            font-weight: 600;
        }
        .table thead th {
            color: #8b949e; /* Gray header text */
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 10px;
        }
    </style>
</head>
<body class="flex flex-col">

    <div id="app" class="flex-grow">
        <!-- Login Scherm -->
        <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
            <div class="card p-8 w-full max-w-md">
                <h2 class="text-3xl font-bold mb-6 text-center text-green-400">API Dashboard Login</h2>
                <div id="login-message" class="p-3 mb-4 rounded-lg text-sm hidden"></div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-400">Gebruikersnaam</label>
                        <input type="text" id="username" value="admin" class="mt-1 block w-full px-3 py-2 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-400">Wachtwoord</label>
                        <input type="password" id="password" value="[admin-wachtwoord]" class="mt-1 block w-full px-3 py-2 border border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button type="submit" class="btn-primary w-full py-2 px-4 rounded-md font-semibold">Inloggen</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Scherm -->
        <div id="dashboard-screen" class="hidden">
            <header class="bg-[#161b22] text-white p-4 shadow-md border-b border-[#30363d]">
                <div class="max-w-7xl mx-auto flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-green-400">G2 API Beheerpaneel</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-display" class="text-sm font-medium text-gray-400"></span>
                        <button id="logout-btn" class="text-sm py-1 px-3 btn-danger rounded font-medium">Uitloggen</button>
                    </div>
                </div>
            </header>

            <main class="max-w-7xl mx-auto p-6 space-y-8">
                
                <!-- Statistieken Overzicht -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card p-6 border-l-4 border-green-500">
                        <p class="text-sm text-gray-400">Actieve Endpoints</p>
                        <p id="stat-endpoints" class="text-3xl font-bold text-gray-200 mt-1">...</p>
                    </div>
                    <div class="card p-6 border-l-4 border-blue-500">
                        <p class="text-sm text-gray-400">Geregistreerde Clients</p>
                        <p id="stat-clients" class="text-3xl font-bold text-gray-200 mt-1">...</p>
                    </div>
                    <div class="card p-6 border-l-4 border-yellow-500">
                        <p class="text-sm text-gray-400">Totaal API Calls</p>
                        <p id="stat-calls" class="text-3xl font-bold text-gray-200 mt-1">...</p>
                    </div>
                </div>

                <!-- Tab Navigatie -->
                <div class="flex border-b border-[#30363d] space-x-4">
                    <button id="tab-api-keys" class="tab-btn active" data-tab="keys">API Sleutels & Beheer</button>
                    <button id="tab-old-endpoints" class="tab-btn" data-tab="old-endpoints">Oude Collecties/Endpoints</button>
                    <button id="tab-activity" class="tab-btn" data-tab="activity">Activiteit</button>
                </div>

                <!-- Tab Content -->
                <div id="tab-content" class="space-y-6">

                    <!-- 1. API Sleutels & Beheer (Keys Tab) -->
                    <div id="content-keys" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6 lg:col-span-3">
                            <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Client Authenticatie Beheer</h3>
                            <div id="settings-message" class="p-3 mb-4 rounded-lg text-sm hidden"></div>

                            <form id="generate-key-form" class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 mb-6">
                                <input type="text" id="new-key-desc" placeholder="Beschrijving (bijv. 'Frontend App')" required class="flex-grow px-3 py-2 border border-gray-700 rounded-md shadow-sm">
                                <button type="submit" class="btn-primary py-2 px-4 rounded-md font-semibold">Genereer Nieuwe Sleutel</button>
                            </form>

                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-700 table">
                                    <thead>
                                        <tr>
                                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider w-1/4">Beschrijving</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider w-1/4">Client ID</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider w-1/2">API Key</th>
                                            <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wider">Acties</th>
                                        </tr>
                                    </thead>
                                    <tbody id="api-keys-table" class="bg-[#161b22] divide-y divide-gray-800">
                                        <!-- Key rijen worden hier geladen door JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Oude Collecties/Endpoints (Old Endpoints Tab) -->
                    <div id="content-old-endpoints" class="hidden">
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-yellow-500">Legacy Collecties</h3>
                            <p class="text-sm text-gray-400 mb-4">Dit zijn de collecties die niet via de nieuwe universele structuur zijn aangemaakt. U kunt hier de data inzien en de collectienaam gebruiken in de API-tester.</p>

                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="old-endpoints-list">
                                <!-- Collecties worden hier geladen door JS -->
                            </div>
                        </div>
                    </div>

                    <!-- 3. Activiteit (Activity Tab) -->
                    <div id="content-activity" class="hidden">
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Recente API Activiteit</h3>
                            <ul id="activity-list" class="space-y-3 text-sm max-h-96 overflow-y-auto pr-2">
                                <!-- Activiteit wordt hier geladen door JS -->
                            </ul>
                        </div>
                    </div>

                </div>

            </main>
        </div>
    </div>

    <script>
        // FIX: Gebruik een relatieve URL /api
        const API_BASE_URL = '/api'; 
        
        // --- DOM Selectors ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        const statEndpoints = document.getElementById('stat-endpoints');
        const statClients = document.getElementById('stat-clients');
        const statCalls = document.getElementById('stat-calls');
        const apiKeysTable = document.getElementById('api-keys-table');
        const generateKeyForm = document.getElementById('generate-key-form');
        const settingsMessage = document.getElementById('settings-message');
        const activityList = document.getElementById('activity-list');
        const oldEndpointsList = document.getElementById('old-endpoints-list');

        let currentUserId = null;

        // --- Hulpfuncties ---
        function showMessage(element, text, isError = false) {
            element.textContent = text;
            element.className = `p-3 mb-4 rounded-lg text-sm ${isError ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'}`;
            element.style.display = 'block';
        }

        function hideMessage(element) {
            element.style.display = 'none';
        }

        function toggleScreens(isLoggedIn) {
            if (isLoggedIn) {
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
            } else {
                loginScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
            }
        }
        
        // --- Tab Handlers ---
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.getAttribute('data-tab');
                // Deactiveer alle knoppen en verberg alle content
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('#tab-content > div').forEach(content => content.classList.add('hidden'));

                // Activeer de geklikte knop en toon de content
                button.classList.add('active');
                document.getElementById(`content-${tab}`).classList.remove('hidden');
            });
        });

        // --- Fetch Functie ---
        async function safeFetch(path, options = {}) { 
            const url = `${API_BASE_URL}${path}`;

            options.credentials = 'include';
            options.headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            try {
                const response = await fetch(url, options);
                let data = null;
                try {
                    data = await response.json();
                } catch (e) {
                    // Negeer: Geen JSON
                }

                if (!response.ok) {
                    if (response.status === 401) {
                        handleLogout(true);
                        throw new Error("Sessie verlopen. Log opnieuw in.");
                    }
                    throw new Error(data?.error || data?.message || `Fout: HTTP Status ${response.status}`);
                }
                return data;

            } catch (error) {
                console.error("Fetch Error:", error);
                throw error;
            }
        }

        // --- Authenticatie Handlers ---

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage(loginMessage);

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                // Pad is /login
                const response = await safeFetch('/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });

                if (response && response.message) {
                    // De browser heeft nu de HTTP-only cookie
                    loadDashboard();
                }

            } catch (error) {
                showMessage(loginMessage, error.message, true);
            }
        });

        logoutBtn.addEventListener('click', () => handleLogout(false));

        async function handleLogout(isSessionExpired) {
            try {
                await safeFetch('/logout', { method: 'POST' });
            } catch (e) {
                // Negeer fouten, we gaan toch uitloggen
            }
            toggleScreens(false);
            showMessage(loginMessage, isSessionExpired ? 'Sessie verlopen. Log opnieuw in.' : 'U bent uitgelogd.', !isSessionExpired);
            userDisplay.textContent = '';
        }

        // --- Dashboard Data Laden ---

        async function loadDashboard() {
            try {
                const dashboardData = await safeFetch('/dashboard');
                const settingsData = await safeFetch('/settings');

                // Toon scherm
                toggleScreens(true);

                // Dashboard Samenvatting
                currentUserId = dashboardData.user_id;
                userDisplay.textContent = `Ingelogd als: ${dashboardData.user_id}`;
                statEndpoints.textContent = dashboardData.summary.endpoints_count;
                statClients.textContent = dashboardData.summary.clients_count;
                statCalls.textContent = dashboardData.summary.calls_count;

                // Recente Activiteit
                renderActivity(dashboardData.recent_activity);
                
                // API Keys
                renderApiKeys(settingsData.api_keys);
                
                // Oude Collecties
                renderOldCollections(dashboardData.all_collections);

            } catch (error) {
                console.error("Dashboard laadfout:", error);
                if (!currentUserId) { 
                    toggleScreens(false);
                }
            }
        }

        // --- Rendering Functies ---
        
        function renderOldCollections(collections) {
            oldEndpointsList.innerHTML = '';
            if (collections.length === 0) {
                oldEndpointsList.innerHTML = '<div class="col-span-full p-4 text-center text-gray-500">Geen oude collecties gevonden. Alles is universeel!</div>';
                return;
            }

            collections.forEach(name => {
                const item = document.createElement('div');
                item.className = 'card p-4 flex flex-col justify-between items-start space-y-2';
                item.innerHTML = `
                    <p class="text-lg font-semibold text-gray-200">${name}</p>
                    <p class="text-xs text-gray-400">Gebruik dit pad in de API Tester.</p>
                    <button class="text-xs text-blue-400 hover:underline" 
                            onclick="copyToClipboardText('${name}')">
                        Kopieer Naam
                    </button>
                `;
                oldEndpointsList.appendChild(item);
            });
        }

        function renderActivity(activity) {
            activityList.innerHTML = '';
            if (activity.length === 0) {
                activityList.innerHTML = '<li class="text-gray-500">Nog geen recente activiteit.</li>';
                return;
            }

            activity.forEach(log => {
                const date = new Date(log.timestamp).toLocaleTimeString();
                const item = document.createElement('li');
                item.className = 'border-b border-gray-800 pb-2';
                item.innerHTML = `
                    <span class="font-mono text-xs text-gray-500">${date}</span>
                    <p class="text-gray-200">${log.action.toUpperCase()} op 
                        <span class="font-semibold text-green-400">${log.endpoint}</span> 
                        (Client: <span class="text-xs font-mono text-blue-400">${log.client_id}</span>)
                    </p>
                `;
                activityList.appendChild(item);
            });
        }

        function renderApiKeys(keys) {
            apiKeysTable.innerHTML = '';

            if (keys.length === 0) {
                apiKeysTable.innerHTML = `<tr><td colspan="4" class="px-3 py-2 text-center text-gray-500">Geen actieve API sleutels gevonden.</td></tr>`;
                return;
            }
            
            keys.forEach(client => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-[#1f242b]';
                
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-200">${client.description}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400 font-mono">${client.client_id}</td>
                    <td class="px-3 py-2 text-sm font-mono flex items-center">
                        <input type="text" value="${client.key}" readonly class="text-xs bg-gray-800 border-none rounded-md p-1 w-full text-green-400" id="key-${client.client_id}">
                        <button class="ml-2 text-gray-500 hover:text-gray-200" onclick="copyToClipboard('key-${client.client_id}', this)" title="Kopieer">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button class="btn-danger text-xs py-1 px-2 rounded" onclick="revokeKey('${client.client_id}')">Trek in</button>
                    </td>
                `;
                apiKeysTable.appendChild(row);
            });
        }

        // Global functie voor kopiëren van input
        window.copyToClipboard = function(elementId, button) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            document.execCommand('copy');
            
            const originalHTML = button.innerHTML;
            button.innerHTML = '<svg class="w-4 h-4 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>';
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 1500);
        };
        
        // Global functie voor kopiëren van pure tekst (voor collectienamen)
        window.copyToClipboardText = function(text) {
             navigator.clipboard.writeText(text).then(() => {
                // In een productieve omgeving zou dit een custom modal zijn in plaats van alert
                alert(`Collectie naam '${text}' gekopieerd!`);
            }).catch(err => {
                console.error('Kopiëren mislukt', err);
                alert('Kopiëren mislukt. Probeer handmatig te selecteren.');
            });
        };

        // --- Key Beheer Handlers ---

        generateKeyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage(settingsMessage);

            const description = document.getElementById('new-key-desc').value;

            try {
                const url = `${API_BASE_URL}/settings`;
                const response = await safeFetch('/settings', {
                    method: 'POST',
                    body: JSON.stringify({ description })
                });

                showMessage(settingsMessage, `Sleutel voor '${description}' gegenereerd. ID: ${response.client_id}`, false);
                document.getElementById('new-key-desc').value = '';
                loadDashboard(); // Herlaad data inclusief nieuwe key

            } catch (error) {
                showMessage(settingsMessage, `Fout bij genereren: ${error.message}`, true);
            }
        });

        window.revokeKey = async function(clientId) {
            if (!confirm(`Weet u zeker dat u Client ID ${clientId} wilt intrekken? Dit is onomkeerbaar!`)) {
                return;
            }
            hideMessage(settingsMessage);

            try {
                await safeFetch('/settings', {
                    method: 'DELETE',
                    body: JSON.stringify({ client_id: clientId })
                });

                showMessage(settingsMessage, `Client ID ${clientId} succesvol ingetrokken.`, false);
                loadDashboard(); 

            } catch (error) {
                showMessage(settingsMessage, `Fout bij intrekken: ${error.message}`, true);
            }
        };


        // --- Initialisatie ---

        // Controleer of de gebruiker al ingelogd is
        loadDashboard(); 
        
    </script>
</body>
</html>
