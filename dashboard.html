<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>G2 Ultimate Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; overflow: hidden; }
        
        /* AANGEPASTE GRID LAYOUT */
        /* Links: 250px | Midden: 500px (2x Links) | Rechts: Rest van de ruimte (1fr) */
        .main-layout { display: grid; grid-template-columns: 250px 500px 1fr; height: 100vh; }
        
        .col-sidebar { background: #161b22; border-right: 1px solid #30363d; overflow-y: auto; }
        .col-list { background: #0d1117; border-right: 1px solid #30363d; overflow-y: auto; display: flex; flex-direction: column; }
        .col-detail { background: #0d1117; overflow-y: auto; display: flex; flex-direction: column; }

        /* Navigation Items */
        .nav-item { padding: 8px 16px; cursor: pointer; border-left: 3px solid transparent; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
        .nav-item:hover { background: #21262d; color: white; }
        .nav-item.active { background: #21262d; border-left-color: #238636; color: white; font-weight: 600; }
        
        /* Endpoint List Item */
        .ep-item { padding: 12px 16px; border-bottom: 1px solid #21262d; cursor: pointer; position: relative; }
        .ep-item:hover { background: #161b22; }
        .ep-item.active { background: #1f242c; border-left: 3px solid #1f6feb; }
        
        /* Status Indicators */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-green { background: #238636; box-shadow: 0 0 5px #238636; }
        .status-orange { background: #d29922; }
        .status-red { background: #da3633; }
        .size-bar { height: 2px; background: #30363d; margin-top: 6px; width: 100%; border-radius: 2px; overflow: hidden; }
        .size-fill { height: 100%; background: #1f6feb; }

        /* Tags & Buttons */
        .tag { font-size: 0.7rem; padding: 1px 5px; border-radius: 4px; background: #30363d; color: #8b949e; }
        .tag-lock { background: #da3633; color: white; }
        
        .btn { padding: 4px 12px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; cursor: pointer; transition: 0.2s; display: inline-flex; items-center; gap: 4px; }
        .btn-blue { background: #1f6feb; color: white; } .btn-blue:hover { background: #388bfd; }
        .btn-red { background: #da3633; color: white; } .btn-red:hover { background: #f85149; }
        .btn-gray { background: #21262d; border: 1px solid #30363d; } .btn-gray:hover { border-color: #8b949e; background: #30363d; }
        
        /* Editor */
        textarea.editor { background: #0d1117; color: #79c0ff; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; width: 100%; border: 1px solid #30363d; padding: 12px; font-size: 13px; outline: none; resize: vertical; min-height: 400px; line-height: 1.5; }
        textarea.editor:focus { border-color: #1f6feb; }
    </style>
</head>
<body>

    <div class="main-layout">
        
        <div class="col-sidebar">
            <div class="p-4 border-b border-[#30363d]">
                <h1 class="font-bold text-white text-lg">G2 Admin</h1>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span id="stat-db-size">- MB</span>
                    <button onclick="runCleanup()" class="text-blue-400 hover:text-white" title="Run TTL Cleanup">üßπ Clean</button>
                </div>
            </div>
            
            <div class="py-2">
                <div class="px-4 text-[10px] font-bold text-gray-500 uppercase mb-2 mt-2">Filters</div>
                <div class="nav-item active" id="filter-all" onclick="applyFilter('ALL', null)">
                    Alle Endpoints <span id="count-all" class="tag">0</span>
                </div>
            </div>

            <div class="py-2">
                <div class="px-4 text-[10px] font-bold text-gray-500 uppercase mb-2">Applicaties</div>
                <div id="list-apps"></div>
            </div>

            <div class="py-2">
                <div class="px-4 text-[10px] font-bold text-gray-500 uppercase mb-2">Clients</div>
                <div id="list-users"></div>
            </div>
            
            <div class="py-2 mt-auto border-t border-[#30363d]">
                <div class="px-4 text-[10px] font-bold text-gray-500 uppercase mb-2 mt-2">Error Log</div>
                <div id="list-errors" class="px-4 text-xs space-y-2 text-red-400"></div>
            </div>
        </div>

        <div class="col-list">
            <div class="p-3 border-b border-[#30363d] bg-[#0d1117] sticky top-0 z-10 flex justify-between">
                <h2 class="font-bold text-white text-sm" id="list-title">Endpoints</h2>
                <button onclick="refresh()" class="text-xs text-blue-400">‚Üª</button>
            </div>
            <div id="endpoints-container" class="flex-grow"></div>
        </div>

        <div class="col-detail">
            <div id="detail-placeholder" class="m-auto text-gray-600 text-center">
                <div class="text-4xl mb-2">‚Üê</div>Selecteer een endpoint
            </div>

            <div id="detail-content" class="hidden flex flex-col h-full">
                <div class="p-6 border-b border-[#30363d] bg-[#161b22]">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center gap-3">
                                <h2 id="det-name" class="text-2xl font-bold text-white">...</h2>
                                <button onclick="renameEndpoint()" class="text-gray-500 hover:text-white" title="Hernoem Endpoint">‚úé</button>
                            </div>
                            
                            <div class="flex gap-2 mt-2">
                                <span id="det-lock-badge" class="tag tag-lock hidden">LOCKED</span>
                                <span id="det-ttl-badge" class="tag hidden">TTL: <span id="det-ttl-val"></span>d</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div id="det-count" class="text-3xl font-bold text-white">-</div>
                            <div class="text-xs text-gray-500">records</div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="downloadEndpoint()" class="btn btn-gray">‚¨á Exporteren</button>
                        <button onclick="doClone()" class="btn btn-gray">content_copy Dupliceren</button>
                        <button onclick="doSnapshot()" class="btn btn-gray">üì∑ Snapshot</button>
                        <div class="flex-grow"></div>
                        <button onclick="dropEndpoint()" class="btn btn-red">üóë Verwijderen</button>
                    </div>
                </div>

                <div class="flex border-b border-[#30363d] px-6 gap-6 text-sm font-bold text-gray-500 bg-[#0d1117]">
                    <button class="py-4 border-b-2 border-[#1f6feb] text-white tab-btn" onclick="switchTab('data')">Data & Editor</button>
                    <button class="py-4 border-b-2 border-transparent hover:text-gray-300 tab-btn" onclick="switchTab('settings')">Instellingen</button>
                </div>

                <div id="tab-data" class="p-6 space-y-4 flex-grow overflow-auto">
                    
                    <div class="flex gap-2">
                        <input type="text" id="search-term" placeholder="Zoek op ID of tekst (Deep Search)..." class="bg-[#161b22] border border-[#30363d] rounded p-2 text-sm text-white flex-grow focus:border-blue-500 outline-none">
                        <button onclick="doSearch()" class="btn btn-blue">Zoeken</button>
                    </div>

                    <div id="editor-area" class="flex gap-6 h-full pb-10">
                        <div class="w-1/3 flex flex-col gap-2 overflow-y-auto h-full pr-2" id="search-results">
                            <div class="text-xs text-gray-500 text-center mt-4">Voer een zoekopdracht uit of klik op 'Zoeken' om de laatste 50 items te laden.</div>
                        </div>

                        <div class="w-2/3 flex flex-col gap-2 h-full">
                            <div class="flex justify-between items-center h-8">
                                <h3 class="text-xs font-bold text-gray-400 uppercase">Editor</h3>
                                <div id="editor-actions" class="hidden">
                                    <button onclick="saveRecord()" class="btn btn-blue text-xs">Opslaan (PUT)</button>
                                </div>
                            </div>
                            <textarea id="json-editor" class="editor rounded hidden"></textarea>
                            <div id="editor-placeholder" class="text-center text-gray-600 mt-20 text-sm border border-dashed border-[#30363d] p-10 rounded">
                                Selecteer een record links om te bewerken
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-settings" class="p-6 space-y-6 hidden max-w-2xl">
                    <div class="p-4 border border-[#30363d] rounded bg-[#161b22]">
                        <h3 class="font-bold text-white mb-2">Endpoint Lock</h3>
                        <p class="text-xs text-gray-500 mb-4">Indien ingeschakeld, kunnen clients alleen lezen (GET). Schrijven (POST/PUT/DELETE) wordt geblokkeerd.</p>
                        <label class="flex items-center gap-2 text-white cursor-pointer select-none">
                            <input type="checkbox" id="set-locked" class="w-4 h-4"> 
                            <span class="font-bold text-red-400">Read-Only Mode activeren</span>
                        </label>
                    </div>

                    <div class="p-4 border border-[#30363d] rounded bg-[#161b22]">
                        <h3 class="font-bold text-white mb-2">Time To Live (TTL)</h3>
                        <p class="text-xs text-gray-500 mb-4">Verwijder automatisch records die ouder zijn dan het ingestelde aantal dagen.</p>
                        <div class="flex items-center gap-2">
                            <input type="number" id="set-ttl" class="bg-[#0d1117] border border-[#30363d] rounded p-2 text-white w-24 focus:border-blue-500 outline-none" placeholder="0">
                            <span class="text-sm text-gray-500">dagen (0 = Nooit verwijderen)</span>
                        </div>
                    </div>
                    
                    <button onclick="saveSettings()" class="btn btn-blue w-full py-2">Instellingen Opslaan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin;
        let globalData = null;
        let currentEp = null;
        let currentRecordId = null;

        // --- CORE ---
        async function refresh() {
            const res = await fetch(`${API}/api/admin/stats`);
            globalData = await res.json();
            
            document.getElementById('stat-db-size').innerText = globalData.db_info.data_size_mb + ' MB';
            document.getElementById('count-all').innerText = globalData.endpoints.length;
            
            renderSidebar();
            renderList();
            renderErrorLog();

            if(currentEp) loadDetail(currentEp);
        }

        function renderSidebar() {
            // Apps
            const apps = {};
            globalData.endpoints.forEach(ep => {
                if(ep.name.includes('_')) {
                    const app = ep.name.split('_')[0];
                    apps[app] = (apps[app] || 0) + 1;
                }
            });
            document.getElementById('list-apps').innerHTML = Object.keys(apps).map(a => 
                `<div class="nav-item" onclick="filterList('${a}_')">${a} <span class="tag">${apps[a]}</span></div>`
            ).join('');

            // Clients
            document.getElementById('list-users').innerHTML = globalData.clients.map(c => `
                <div class="nav-item">
                    <div class="flex flex-col">
                        <span>${c.client_id}</span>
                        <span class="text-[9px] text-gray-500">${c.last_seen ? timeAgo(c.last_seen) : 'Nooit'}</span>
                    </div>
                    <span class="tag">${c.total_records}</span>
                </div>
            `).join('');
        }

        function renderList(filterPrefix = '') {
            const list = document.getElementById('endpoints-container');
            const filtered = globalData.endpoints.filter(ep => ep.name.startsWith(filterPrefix));
            
            list.innerHTML = filtered.map(ep => {
                let statusColor = 'status-red';
                if(ep.last_activity) {
                    const diff = (new Date() - new Date(ep.last_activity)) / 1000 / 60;
                    if(diff < 60) statusColor = 'status-green';
                    else if(diff < 60 * 24) statusColor = 'status-orange';
                }

                return `
                <div class="ep-item ${currentEp === ep.name ? 'active' : ''}" onclick="selectEp('${ep.name}')">
                    <div class="flex justify-between items-center mb-1">
                        <div class="font-mono text-sm text-blue-300 truncate w-64" title="${ep.name}">${ep.name}</div>
                        <div class="${statusColor} status-dot" title="Actief: ${ep.last_activity || 'Nooit'}"></div>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>${ep.count} records</span>
                        ${ep.locked ? '<span class="text-red-500 font-bold">üîí LOCKED</span>' : ''}
                    </div>
                    <div class="size-bar"><div class="size-fill" style="width: ${ep.size_pct}%"></div></div>
                </div>`;
            }).join('');
            
            document.getElementById('list-title').innerText = filterPrefix ? `Filter: ${filterPrefix}*` : 'Alle Endpoints';
        }

        function filterList(prefix) { renderList(prefix); }

        function selectEp(name) {
            currentEp = name;
            renderList();
            document.getElementById('detail-placeholder').classList.add('hidden');
            document.getElementById('detail-content').classList.remove('hidden');
            
            // Reset editor state
            document.getElementById('json-editor').classList.add('hidden');
            document.getElementById('editor-placeholder').classList.remove('hidden');
            document.getElementById('editor-actions').classList.add('hidden');
            document.getElementById('search-results').innerHTML = '<div class="text-xs text-gray-500 text-center mt-4">Klik op zoeken...</div>';
            
            loadDetail(name);
        }

        function loadDetail(name) {
            const ep = globalData.endpoints.find(e => e.name === name);
            document.getElementById('det-name').innerText = name;
            document.getElementById('det-count').innerText = ep.count;
            
            document.getElementById('det-lock-badge').classList.toggle('hidden', !ep.locked);
            document.getElementById('det-ttl-badge').classList.toggle('hidden', !(ep.ttl > 0));
            if(ep.ttl > 0) document.getElementById('det-ttl-val').innerText = ep.ttl;

            document.getElementById('set-locked').checked = ep.locked;
            document.getElementById('set-ttl').value = ep.ttl || '';
        }

        // --- ACTIONS ---

        async function doSearch() {
            const term = document.getElementById('search-term').value;
            const res = await fetch(`${API}/api/admin/search`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ collection: currentEp, term })
            });
            const docs = await res.json();
            
            const container = document.getElementById('search-results');
            if(docs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-4 text-xs">Geen resultaten</div>';
            } else {
                container.innerHTML = docs.map(d => `
                    <div class="p-3 border border-[#30363d] rounded bg-[#161b22] hover:bg-[#21262d] cursor-pointer" onclick="loadRecord('${d._id}')">
                        <div class="text-[10px] text-blue-400 font-mono mb-1">${d._id}</div>
                        <div class="text-xs text-gray-400 truncate font-mono">${JSON.stringify(cleanDisplay(d))}</div>
                    </div>
                `).join('');
            }
        }

        function cleanDisplay(d) {
            // Helper om preview iets schoner te maken (zonder meta velden)
            const c = {...d};
            delete c._id; delete c._client_id; delete c._created_at; delete c._updated_at;
            return c;
        }

        async function loadRecord(id) {
            // Fetch fresh record
            currentRecordId = id;
            const res = await fetch(`${API}/api/admin/search`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ collection: currentEp, term: id })
            });
            const docs = await res.json();
            
            if(docs[0]) {
                document.getElementById('json-editor').value = JSON.stringify(docs[0], null, 4);
                document.getElementById('json-editor').classList.remove('hidden');
                document.getElementById('editor-placeholder').classList.add('hidden');
                document.getElementById('editor-actions').classList.remove('hidden');
            }
        }

        async function saveRecord() {
            try {
                const data = JSON.parse(document.getElementById('json-editor').value);
                const res = await fetch(`${API}/api/admin/record/${currentEp}/${currentRecordId}`, {
                    method: 'PUT', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(data)
                });
                if(res.ok) {
                    alert("Opgeslagen!");
                    doSearch(); // Refresh list to show changes
                } else {
                    const j = await res.json();
                    alert("Fout: " + j.error);
                }
            } catch(e) { alert("Ongeldige JSON format"); }
        }

        async function renameEndpoint() {
            const newName = prompt("Nieuwe naam voor " + currentEp + ":", currentEp);
            if(newName && newName !== currentEp) {
                const res = await fetch(`${API}/api/admin/rename`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ old_name: currentEp, new_name: newName })
                });
                if(res.ok) {
                    currentEp = newName;
                    refresh();
                    selectEp(newName);
                } else alert("Fout bij hernoemen");
            }
        }

        // --- STANDARD TOOLS ---
        async function dropEndpoint() {
            if(confirm(`Weet je zeker dat je ${currentEp} wilt verwijderen?`)) {
                await fetch(`${API}/api/admin/collections/${currentEp}`, { method: 'DELETE' });
                window.location.reload();
            }
        }
        function downloadEndpoint() { window.location.href = `${API}/api/admin/export/${currentEp}`; }
        
        async function doClone() {
            const dest = prompt("Naam voor kopie:", currentEp + "_copy");
            if(dest) {
                await fetch(`${API}/api/admin/clone`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ source: currentEp, destination: dest })
                });
                refresh();
            }
        }
        
        async function doSnapshot() {
            const res = await fetch(`${API}/api/admin/snapshot`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ collection: currentEp })
            });
            const d = await res.json();
            alert("Snapshot gemaakt: " + d.snapshot);
        }

        async function saveSettings() {
            const locked = document.getElementById('set-locked').checked;
            const ttl = document.getElementById('set-ttl').value;
            await fetch(`${API}/api/admin/settings`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ collection: currentEp, locked, ttl_days: ttl })
            });
            refresh();
            alert("Instellingen opgeslagen");
        }
        
        async function runCleanup() {
            const res = await fetch(`${API}/api/admin/cleanup`, { method: 'POST' });
            const d = await res.json();
            alert(d.report.length ? d.report.join('\n') : "Alles is schoon.");
        }

        function renderErrorLog() {
            document.getElementById('list-errors').innerHTML = globalData.errors.length ? globalData.errors.map(e => 
                `<div class="truncate" title="${e.msg}"><span class="text-gray-500">[${e.time.split('T')[1].substr(0,5)}]</span> ${e.msg}</div>`
            ).join('') : '<span class="text-gray-600">Geen meldingen</span>';
        }

        function switchTab(t) {
            ['data','settings'].forEach(x => document.getElementById(`tab-${x}`).classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            
            // Visual tabs styling logic (simplified)
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('border-[#1f6feb]', 'text-white');
                b.classList.add('border-transparent');
            });
            event.target.classList.remove('border-transparent');
            event.target.classList.add('border-[#1f6feb]', 'text-white');
        }

        function timeAgo(d) {
            const s = Math.floor((new Date() - new Date(d))/1000);
            if(s<60) return s+"s"; if(s<3600) return Math.floor(s/60)+"m"; if(s<86400) return Math.floor(s/3600)+"u"; return Math.floor(s/86400)+"d";
        }

        refresh();
        setInterval(refresh, 60000);

    </script>
</body>
</html>
